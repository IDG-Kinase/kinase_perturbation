---
title: "Drug Pertubations - DESeq2 Analysis"
author: "Matthew Berginski"
date: "2/17/2020"
output: html_document
---

```{r setup, include=FALSE}
library("tximeta")
library("DESeq2")

library("AnnotationDbi")
library("org.Hs.eg.db")
library(biomaRt)

library(DarkKinaseTools)
library(here)
library(tidyverse)
library(glue)
```

```{r}
if (! file.exists(here('gene_to_hgnc.csv'))) {
	ensembl = biomaRt::useMart("ensembl",dataset="hsapiens_gene_ensembl")
	gene_to_hgnc = biomaRt::getBM(attributes = c('ensembl_gene_id','hgnc_symbol'), mart = ensembl)
	write_csv(gene_to_hgnc, here('gene_to_hgnc.csv'))
} else {
	gene_to_hgnc = readr::read_csv(here('gene_to_hgnc.csv'))
}
```

```{r}
summary_stats = tribble(~treatment,~batch,~number_2fold,~num_kinases,~num_dark_kinases,~dk_diff_str)

#get the function used to run DESeq2 and return results
source(here('shared_functions.R'))
```

# Batch 1

## Dinaciclib

```{r}
results = run_DESeq2(tribble(
	~files, ~batch, ~rep, ~treatment,
	
	here('salmon_alignments/batch_01/rep_01/DMSO/quant.sf'), 1, 1, "DMSO",
	here('salmon_alignments/batch_01/rep_01/Dinac/quant.sf'), 1, 1, "Dina",
	here('salmon_alignments/batch_01/rep_02/DMSO/quant.sf'), 1, 2, "DMSO",
	here('salmon_alignments/batch_01/rep_02/Dinac/quant.sf'), 1, 2, "Dina"
))
results$treatment = "Dinaciclib"
results$batch = 1

summary_stats = rbind(results)
```

## Entinostat

```{r}
results = run_DESeq2(tribble(
	~files, ~batch, ~rep, ~treatment,
	
	here('salmon_alignments/batch_01/rep_01/DMSO/quant.sf'), 1, 1, "DMSO",
	here('salmon_alignments/batch_01/rep_01/Ent/quant.sf'), 1, 1, "Ent",
	here('salmon_alignments/batch_01/rep_02/DMSO/quant.sf'), 1, 2, "DMSO",
	here('salmon_alignments/batch_01/rep_02/Ent/quant.sf'), 1, 2, "Ent"
))
results$treatment = "Entinostat"
results$batch = 1

summary_stats = rbind(summary_stats,results)
```

## JIB-04 Low Dose

```{r}
results = run_DESeq2(tribble(
	~files, ~batch, ~rep, ~treatment,
	
	here('salmon_alignments/batch_01/rep_01/DMSO/quant.sf'), 1, 1, "DMSO",
	here('salmon_alignments/batch_01/rep_01/JIB04/quant.sf'), 1, 1, "JIB-04",
	here('salmon_alignments/batch_01/rep_02/DMSO/quant.sf'), 1, 2, "DMSO",
	here('salmon_alignments/batch_01/rep_02/JIB04/quant.sf'), 1, 2, "JIB-04"
))
results$treatment = "JIB-04 (low dose)"
results$batch = 1

summary_stats = rbind(summary_stats,results)
```

## MK2206

```{r}
results = run_DESeq2(tribble(
	~files, ~batch, ~rep, ~treatment,
	
	here('salmon_alignments/batch_01/rep_01/DMSO/quant.sf'), 1, 1, "DMSO",
	here('salmon_alignments/batch_01/rep_01/MK2206/quant.sf'), 1, 1, "MK2206",
	here('salmon_alignments/batch_01/rep_02/DMSO/quant.sf'), 1, 2, "DMSO",
	here('salmon_alignments/batch_01/rep_02/MK2206/quant.sf'), 1, 2, "MK2206"
))
results$treatment = "MK2206"
results$batch = 1

summary_stats = rbind(summary_stats,results)
```

## Trametinib

```{r}
results = run_DESeq2(tribble(
	~files, ~batch, ~rep, ~treatment,
	
	here('salmon_alignments/batch_01/rep_01/DMSO/quant.sf'), 1, 1, "DMSO",
	here('salmon_alignments/batch_01/rep_01/Tram/quant.sf'), 1, 1, "Tram",
	here('salmon_alignments/batch_01/rep_02/DMSO/quant.sf'), 1, 2, "DMSO",
	here('salmon_alignments/batch_01/rep_02/Tram/quant.sf'), 1, 2, "Tram"
))
results$treatment = "Trametinib"
results$batch = 1

summary_stats = rbind(summary_stats,results)
```

# Batch 2

## JIB-04 (high dose)

```{r}
results = run_DESeq2(tribble(
	~files, ~batch, ~rep, ~treatment,
	
	here('salmon_alignments/batch_02/rep_01/DMSO/quant.sf'), 2, 1, "DMSO",
	here('salmon_alignments/batch_02/rep_01/JIB04/quant.sf'), 2, 1, "JIB-04",
	here('salmon_alignments/batch_02/rep_02/DMSO/quant.sf'), 2, 2, "DMSO",
	here('salmon_alignments/batch_02/rep_02/JIB04/quant.sf'), 2, 2, "JIB-04"
))
results$treatment = "JIB-04 (high dose)"
results$batch = 2

summary_stats = rbind(summary_stats,results)
```

## Navitoclax

```{r}
results = run_DESeq2(tribble(
	~files, ~batch, ~rep, ~treatment,
	
	here('salmon_alignments/batch_02/rep_01/DMSO/quant.sf'), 2, 1, "DMSO",
	here('salmon_alignments/batch_02/rep_01/Navi/quant.sf'), 2, 1, "Navi",
	here('salmon_alignments/batch_02/rep_02/DMSO/quant.sf'), 2, 2, "DMSO",
	here('salmon_alignments/batch_02/rep_02/Navi/quant.sf'), 2, 2, "Navi"
))
results$treatment = "Navitoclax"
results$batch = 2

summary_stats = rbind(summary_stats,results)
```

## Paclitaxel

```{r}
results = run_DESeq2(tribble(
	~files, ~batch, ~rep, ~treatment,
	
	here('salmon_alignments/batch_02/rep_01/DMSO/quant.sf'), 2, 1, "DMSO",
	here('salmon_alignments/batch_02/rep_01/Paclit/quant.sf'), 2, 1, "Paclit",
	here('salmon_alignments/batch_02/rep_02/DMSO/quant.sf'), 2, 2, "DMSO",
	here('salmon_alignments/batch_02/rep_02/Paclit/quant.sf'), 2, 2, "Paclit"
))
results$treatment = "Paclitaxel"
results$batch = 2

summary_stats = rbind(summary_stats,results)
```

## Ruxolibinib

```{r}
results = run_DESeq2(tribble(
	~files, ~batch, ~rep, ~treatment,
	
	here('salmon_alignments/batch_02/rep_01/DMSO/quant.sf'), 2, 1, "DMSO",
	here('salmon_alignments/batch_02/rep_01/Rux/quant.sf'), 2, 1, "Rux",
	here('salmon_alignments/batch_02/rep_02/DMSO/quant.sf'), 2, 2, "DMSO",
	here('salmon_alignments/batch_02/rep_02/Rux/quant.sf'), 2, 2, "Rux"
))
results$treatment = "Ruxolibinib"
results$batch = 2

summary_stats = rbind(summary_stats,results)
```

## SGCCP30

```{r}
results = run_DESeq2(tribble(
	~files, ~batch, ~rep, ~treatment,
	
	here('salmon_alignments/batch_02/rep_01/DMSO/quant.sf'), 2, 1, "DMSO",
	here('salmon_alignments/batch_02/rep_01/SGC/quant.sf'), 2, 1, "SGC",
	here('salmon_alignments/batch_02/rep_02/DMSO/quant.sf'), 2, 2, "DMSO",
	here('salmon_alignments/batch_02/rep_02/SGC/quant.sf'), 2, 2, "SGC"
))
results$treatment = "SGCCP30"
results$batch = 2

summary_stats = rbind(summary_stats,results)
```

# Batch 3

## Alisertib

```{r}
results = run_DESeq2(tribble(
	~files, ~batch, ~rep, ~treatment,
	
	here('salmon_alignments/batch_03/rep_01/DMSO/quant.sf'), 3, 1, "DMSO",
	here('salmon_alignments/batch_03/rep_01/Alis/quant.sf'), 3, 1, "Alis",
	here('salmon_alignments/batch_03/rep_02/DMSO/quant.sf'), 3, 2, "DMSO",
	here('salmon_alignments/batch_03/rep_02/Alis/quant.sf'), 3, 2, "Alis"
))
results$treatment = "Alisertib"
results$batch = 3

summary_stats = rbind(summary_stats,results)
```

## Bortezomib

```{r}
results = run_DESeq2(tribble(
	~files, ~batch, ~rep, ~treatment,
	
	here('salmon_alignments/batch_03/rep_01/DMSO/quant.sf'), 3, 1, "DMSO",
	here('salmon_alignments/batch_03/rep_01/Bort/quant.sf'), 3, 1, "Bort",
	here('salmon_alignments/batch_03/rep_02/DMSO/quant.sf'), 3, 2, "DMSO",
	here('salmon_alignments/batch_03/rep_02/Bort/quant.sf'), 3, 2, "Bort"
))
results$treatment = "Bortezomib"
results$batch = 3

summary_stats = rbind(summary_stats,results)
```

## CoCl2

```{r}
results = run_DESeq2(tribble(
	~files, ~batch, ~rep, ~treatment,
	
	here('salmon_alignments/batch_03/rep_01/DMSO/quant.sf'), 3, 1, "DMSO",
	here('salmon_alignments/batch_03/rep_01/CoCl2/quant.sf'), 3, 1, "CoCl2",
	here('salmon_alignments/batch_03/rep_02/DMSO/quant.sf'), 3, 2, "DMSO",
	here('salmon_alignments/batch_03/rep_02/CoCl2/quant.sf'), 3, 2, "CoCl2"
))
results$treatment = "CoCl2"
results$batch = 3

summary_stats = rbind(summary_stats,results)
```

## FCCP

```{r}
results = run_DESeq2(tribble(
	~files, ~batch, ~rep, ~treatment,
	
	here('salmon_alignments/batch_03/rep_01/DMSO/quant.sf'), 3, 1, "DMSO",
	here('salmon_alignments/batch_03/rep_01/FCCP/quant.sf'), 3, 1, "FCCP",
	here('salmon_alignments/batch_03/rep_02/DMSO/quant.sf'), 3, 2, "DMSO",
	here('salmon_alignments/batch_03/rep_02/FCCP/quant.sf'), 3, 2, "FCCP"
))
results$treatment = "FCCP"
results$batch = 3

summary_stats = rbind(summary_stats,results)
```

## Palbociclib

```{r}
results = run_DESeq2(tribble(
	~files, ~batch, ~rep, ~treatment,
	
	here('salmon_alignments/batch_03/rep_01/DMSO/quant.sf'), 3, 1, "DMSO",
	here('salmon_alignments/batch_03/rep_01/Palbo/quant.sf'), 3, 1, "Palbo",
	here('salmon_alignments/batch_03/rep_02/DMSO/quant.sf'), 3, 2, "DMSO",
	here('salmon_alignments/batch_03/rep_02/Palbo/quant.sf'), 3, 2, "Palbo"
))
results$treatment = "Palbociclib"
results$batch = 3

summary_stats = rbind(summary_stats,results)
```

# Summary Output

```{r}
summary_stats_output = summary_stats %>% 
	select(treatment,batch,everything()) %>% 
	rename("Genes" = number_2fold,
				 "Kinases" = num_kinases,
				 "Dark Kinases" = num_dark_kinases,
				 "IDG Kinases" = dk_diff_str)

write_csv(summary_stats_output,here('DESeq2_summary.csv'))
```